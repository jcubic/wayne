<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <meta name="Description" content=""/>
    <link rel="shortcut icon" href=""/>
    <!--[if IE]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
     pre {
         white-space: pre-wrap;
     }
    </style>
</head>
<body>
<button id="input" disabled>send</button>
<select id="user_id">
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
</select>
<button id="error" disabled>error</button>
<button id="redirect" disabled>redirect</button>
<button id="external_redirect" disabled>external redirect</button>
<button id="glob" disabled>glob</button>
<button id="rpc" disabled>random rpc</button>
<a href="./download" target="_blank">download</a>
<br/>
<br/>
<div>
  <strong>SSE (Server Sent Events) stream</strong>
  <br/>
  <button id="sse_start">Start</button>
  <button id="sse_stop">Stop</button>
</div>

<pre id="output">Loading Service Worker</pre>
<script>
 if ('serviceWorker' in navigator) {
     var scope = location.pathname.replace(/\/[^\/]+$/, '/');
     navigator.serviceWorker.register('sw.js', {scope})
              .then(function(reg) {
                  reg.addEventListener('updatefound', function() {
                      var installingWorker = reg.installing;
                      console.log('A new service worker is being installed:',
                                  installingWorker);
                  });
                  // registration worked
                  console.log('Registration succeeded. Scope is ' + reg.scope);
                  input.disabled = false;
                  error.disabled = false;
                  redirect.disabled = false;
                  rpc.disabled = false;
                  glob.disabled = false;
                  external_redirect.disabled = false;
                  set('Ready');
              }).catch(function(error) {
                  // registration failed
                  console.log('Registration failed with ' + error);
              });
 }

 function get(url) {
     fetch(url)
         .then(res => res.text())
         .then(set);
 }

 function set(text) {
     output.innerHTML = text;
 }

 function clear() {
     output.innerHTML = '';
 }

 function log(text) {
     output.innerHTML += text + '\n';
 }

 input.addEventListener('click', () => {
     get(`./user/${user_id.value}`);
 });

 error.addEventListener('click', () => {
     get(`./error`);
 });

 redirect.addEventListener('click', () => {
     get('./redirect');
 });

 external_redirect.addEventListener('click', () => {
     get('./external');
 });

 let see_source;

 sse_start.addEventListener('click', () => {
     see_source = new EventSource("./sse");
     clear();
     see_source.onmessage = event => {
         log(event.data);
     };
 });

 sse_stop.addEventListener('click', () => {
     if (see_source) {
         see_source.close();
         see_source = null;
     }
 });

 glob.addEventListener('click', () => {
    get(`./__fs__/hello/world/name/this/is/fine`);
 });

 let index = 0;
 const requests = [
     './rpc/ping/',
     './rpc/json/',
     './rpc/random/',
     './rpc/sin/10'
 ];

 rpc.addEventListener('click', () => {
     get(random_request() );
 });

 function random_request() {
     const next_index = index++ % requests.length;
     return requests[next_index];
 }

 const channel = new BroadcastChannel('rpc');
 const methods = {
     ping: function() {
         return 'pong';
     },
     sin: function(x) {
         return Math.sin(x);
     },
     random: function() {
         return Math.random();
     },
     json: function() {
         return fetch('https://api.npoint.io/8c7cc24b3fd405b775ce').then(res => res.json());
     }
 };
 channel.addEventListener('message', async function handler(message) {
     if (Object.keys(message.data).includes('method', 'id', 'args')) {
         const { method, id, args } = message.data;
         try {
             const result = await methods[method](...args);
             channel.postMessage({id, result});
         } catch(error) {
             channel.postMessage({id, error});
         }
     }
 });
</script>
</body>
</html>
